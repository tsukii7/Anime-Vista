> ğŸŒ View in Chinese: [ç®€ä½“ä¸­æ–‡](./README.zh-CN.md)

## ğŸ”€ 1. Routing System Design (React Router v7)

This project uses React Router v7 as the SPA routing manager, with its built-in support for Server-Side Rendering (SSR).
React Router v7 offers three distinct usage modes tailored to different project scales and architectures:

- Data Mode: The most direct form of React Router usage, requiring manual setup with `createBrowserRouter()` and
  `createRoutesFromElements()`. Best for projects needing maximum flexibility.
- Declarative Mode: Defines routes using JSX elements like `<Routes>` and `<Route>`. This is intuitive and well-suited
  for most small to medium SPAs.
- Framework Mode: Designed for larger applications, this mode integrates with the `@react-router/dev` toolchain to
  support file-based routing, SSR, and optimized builds. It is the most feature-rich and recommended setup.

This project adopts Framework Mode to enable a unified SSR build pipeline, high configurability, and clean route
declarations.

---

## ğŸ“ 2. Routing Directory Structure & Files

Using Framework Mode requires the following structure:

### ğŸ“ `src/routes/`

- [`entry.client.jsx`](../../src/routes/entry.client.jsx):  
  The client entry file. Uses `<HydratedRouter>` to hydrate server-rendered content into an interactive React app.

- [`root.jsx`](../../src/routes/root.jsx):  
  Root layout component for the app. Defines common UI elements like `<TopBar>` and `<SideBar>`, and uses `<Outlet>` to
  render nested child routes.

- [`routes.js`](../../src/routes/routes.js):  
  Main route configuration. Builds the full route tree using `route()` and `index()` utilities from
  `@react-router/dev/routes`.

### ğŸ“ Project Root

- [`.react-router/`](../../.react-router):  
  A build cache directory generated by `@react-router/dev`, containing intermediate artifacts (e.g., route dependency
  graphs). Should be `.gitignore`d.

- [`react-router.config.js`](../../react-router.config.js):  
  Configuration file specifying the routes directory (`src/routes`) and enabling SSR mode.

## âš™ï¸ 3. Build Scripts & Custom Tools

Routing-related commands in `package.json`:

```json
"scripts": {
"dev": "react-router dev",
"build": "react-router build && node scripts/copySSR.mjs",
"start": "node server.js"
}
```

- `react-router dev`: Starts the development server with SSR and HMR.
- `react-router build`: Generates both SSR and client-side build outputs.
- `node scripts/copySSR.mjs`: Custom script to copy SSR output to Firebase Functions directory for deployment.

## ğŸ 4. Common Pitfall & Solution During Development

### 4.1 Routing Structure

When declaring routes, use the following flat structure:

```js
export default [
    index('../presenters/HomePresenter.jsx'),
    route('about', '../presenters/AboutPresenter.jsx'),
    route('current', '../presenters/CurrentPresenter.jsx'),
    route('details/:id', '../presenters/DetailsPresenter.jsx'),
    route('login', '../presenters/LoginRegisterPresenter.jsx'),
    route('rank', '../presenters/RankPresenter.jsx'),
    route('search', '../presenters/SearchPresenter.jsx'),
    route(':userNumber', '../presenters/MePresenter.jsx')
]
```

DO NOT nest the root layout manually like this:

```js
export default [
    route('', './root.jsx', [
        index('../presenters/HomePresenter.jsx'),
        ...
    ])
]
```

The reason is that, React Router assumes the first-level `index()` route as the root, assigning it `id = "root"` and
`parentId = ""`. If you
manually nest the root like in the second example, it incorrectly sets `parentId: 'root'`, causing SSR to break.

> Reference: The logic in `@react-router/dev/dist/vite.js` around line 3953 (`createPrerenderRoutes()`) fetches the root
> via `routesByParentId['']`.

To avoid this:

- Declare all first-level routes as top-level array items.
- Use `<Outlet>` inside `root.jsx` to handle shared layout rendering.

### 4.2 Route Declaration Order

```js
export default [
    index('../presenters/HomePresenter.jsx'),
    ...
    route(':userNumber', '../presenters/MePresenter.jsx') // must be the last one
]
```

Our goal is to enable direct navigation to a user's profile page via `:userNumber`, while ensuring routes like `about`
lead to their respective pages.

In most frontend routing libraries (including React Router and similar custom implementations), the order of route
declarations determines their matching priority. Routes defined earlier have higher priority. The routing system checks
each route in the order they are declared, and once it finds the first match, it stops searching.

`:userNumber` is a **dynamic parameter route**, meaning it can match any path segment. To prevent it from prematurely
matching specific routes like `about` or `login`, it must be placed **at the end** of the route list. This ensures it
only takes effect when all the more specific routes have failed to match. If it's placed earlier, it may "consume" paths
that should be handled by more precise routes.
